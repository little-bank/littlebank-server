<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LittleBank 실시간 채팅</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h1>💬 LittleBank 실시간 채팅</h1>

<label for="tokenInput">🔑 Access Token 입력 (Bearer 제외):</label><br />
<input type="text" id="tokenInput" placeholder="eyJhbGciOi..." size="80" /><br><br>

<label for="roomInput">💬 채팅방 ID:</label><br />
<input type="text" id="roomInput" placeholder="예: room1" /><br><br>

<button onclick="connectWebSocket()">🔌 연결</button>

<hr/>

<input type="text" id="messageInput" placeholder="메시지를 입력하세요" />
<button onclick="sendMessage()">📤 보내기</button>

<ul id="chatBox"></ul>

<script>
    let stompClient = null;
    let connectedRoomId = null;

    function connectWebSocket() {
        const accessToken = document.getElementById("tokenInput").value.trim();
        const roomId = document.getElementById("roomInput").value.trim();

        if (!accessToken || !roomId) {
            alert("Access Token과 채팅방 ID를 모두 입력해주세요.");
            return;
        }

        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);

        const headers = {
            Authorization: "Bearer " + accessToken
        };

        stompClient.connect(headers, function (frame) {
            console.log("✅ WebSocket 연결 성공", frame);
            alert("WebSocket 연결 성공!");

            connectedRoomId = roomId;

            stompClient.subscribe(`/topic/chat/${roomId}`, function (message) {
                const response = JSON.parse(message.body);
                const content = `[${response.sender}] ${response.message}`;
                const listItem = document.createElement("li");
                listItem.textContent = content;
                document.getElementById("chatBox").appendChild(listItem);
            });
        }, function (error) {
            console.error("❌ WebSocket 연결 실패", error);
            alert("WebSocket 연결 실패: " + error);
        });
    }

    function sendMessage() {
        const msg = document.getElementById("messageInput").value.trim();
        const receiverId = 2; // 🔁 필요에 따라 동적 처리 가능

        if (!connectedRoomId) {
            alert("먼저 채팅방을 연결해주세요.");
            return;
        }

        if (!msg) {
            alert("보낼 메시지를 입력하세요.");
            return;
        }

        if (stompClient && stompClient.connected) {
            stompClient.send(`/app/api-user/chat.send.${connectedRoomId}`, {}, JSON.stringify({
                receiverId: receiverId,
                message: msg,
                type: "TALK"
            }));
            document.getElementById("messageInput").value = "";
        } else {
            alert("먼저 WebSocket 연결을 해주세요.");
        }
    }
</script>
</body>
</html>