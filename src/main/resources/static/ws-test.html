<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>💬 JWT 인증 기반 실시간 채팅 테스트</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { margin: 5px 0; }
    ul { list-style: none; padding-left: 0; }
    li { margin: 3px 0; }
  </style>
</head>
<body>
<h2>💬 JWT 인증 기반 채팅 테스트</h2>

<label>사용자 ID:</label><br>
<input type="text" id="senderInput" placeholder="예: user1"><br><br>

<label>채팅방 ID:</label><br>
<input type="text" id="roomIdInput" placeholder="예: room123"><br><br>

<label>🔑 Access Token (Bearer 제외):</label><br>
<input type="text" id="tokenInput" placeholder="eyJhbGciOi..." size="80"><br><br>

<button onclick="connect()">🔗 연결</button>

<hr>

<input type="text" id="messageInput" placeholder="메시지를 입력하세요" style="width: 300px;">
<button onclick="sendMessage()">📤 보내기</button>

<ul id="chatBox"></ul>

<script>
  let stompClient = null;
  let connectedRoomId = null;
  let senderId = null;

  function connect() {
    senderId = document.getElementById("senderInput").value.trim();
    connectedRoomId = document.getElementById("roomIdInput").value.trim();
    const accessToken = document.getElementById("tokenInput").value.trim();

    if (!senderId || !connectedRoomId || !accessToken) {
      alert("사용자 ID, 채팅방 ID, 토큰을 모두 입력해주세요.");
      return;
    }

    const socket = new SockJS("/ws-chat");
    stompClient = Stomp.over(socket);

    const headers = {
      token: "Bearer " + accessToken // ✅ 서버에서 getFirstNativeHeader("token")으로 받아야 함
    };

    stompClient.connect(headers, function (frame) {
      console.log("✅ WebSocket 연결 성공:", frame);

      // ✅ 연결 후 구독
      stompClient.subscribe(`/topic/chat/${connectedRoomId}`, function (message) {
        const body = JSON.parse(message.body);
        const content = `[${body.sender}] ${body.message}`;
        const li = document.createElement("li");
        li.textContent = content;
        document.getElementById("chatBox").appendChild(li);
      });

      alert("✅ 채팅방에 입장하였습니다.");
    }, function (error) {
      console.error("❌ 연결 실패:", error);
      alert("WebSocket 연결 실패: " + error);
    });
  }

  function sendMessage() {
    const message = document.getElementById("messageInput").value.trim();
    if (!message || !stompClient || !connectedRoomId || !senderId) return;

    // 서버에 메시지 전송
    stompClient.send(`/app/api-user/chat.send.${connectedRoomId}`, {}, JSON.stringify({
      sender: senderId,
      message: message,
      type: "TALK"
    }));

    // 내 화면에 메시지 바로 표시
    const li = document.createElement("li");
    li.textContent = `[나 (${senderId})] ${message}`;
    document.getElementById("chatBox").appendChild(li);

    document.getElementById("messageInput").value = "";
  }
</script>
</body>
</html>