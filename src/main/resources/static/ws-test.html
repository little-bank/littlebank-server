<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LittleBank ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h1>ğŸ’¬ LittleBank ì‹¤ì‹œê°„ ì±„íŒ…</h1>

<label for="tokenInput">ğŸ”‘ Access Token ì…ë ¥ (Bearer ì œì™¸):</label><br />
<input type="text" id="tokenInput" placeholder="eyJhbGciOi..." size="80" /><br><br>

<label for="roomInput">ğŸ’¬ ì±„íŒ…ë°© ID:</label><br />
<input type="text" id="roomInput" placeholder="ì˜ˆ: room1" /><br><br>

<button onclick="connectWebSocket()">ğŸ”Œ ì—°ê²°</button>

<hr/>

<input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
<button onclick="sendMessage()">ğŸ“¤ ë³´ë‚´ê¸°</button>

<ul id="chatBox"></ul>

<script>
    let stompClient = null;
    let connectedRoomId = null;

    function connectWebSocket() {
        const accessToken = document.getElementById("tokenInput").value.trim();
        const roomId = document.getElementById("roomInput").value.trim();

        if (!accessToken || !roomId) {
            alert("Access Tokenê³¼ ì±„íŒ…ë°© IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);

        const headers = {
            Authorization: "Bearer " + accessToken
        };

        stompClient.connect(headers, function (frame) {
            console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ", frame);
            alert("WebSocket ì—°ê²° ì„±ê³µ!");

            connectedRoomId = roomId;

            stompClient.subscribe(`/topic/chat/${roomId}`, function (message) {
                const response = JSON.parse(message.body);
                const content = `[${response.sender}] ${response.message}`;
                const listItem = document.createElement("li");
                listItem.textContent = content;
                document.getElementById("chatBox").appendChild(listItem);
            });
        }, function (error) {
            console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨", error);
            alert("WebSocket ì—°ê²° ì‹¤íŒ¨: " + error);
        });
    }

    function sendMessage() {
        const msg = document.getElementById("messageInput").value.trim();
        const receiverId = 2; // ğŸ” í•„ìš”ì— ë”°ë¼ ë™ì  ì²˜ë¦¬ ê°€ëŠ¥

        if (!connectedRoomId) {
            alert("ë¨¼ì € ì±„íŒ…ë°©ì„ ì—°ê²°í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!msg) {
            alert("ë³´ë‚¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        if (stompClient && stompClient.connected) {
            stompClient.send(`/app/api-user/chat.send.${connectedRoomId}`, {}, JSON.stringify({
                receiverId: receiverId,
                message: msg,
                type: "TALK"
            }));
            document.getElementById("messageInput").value = "";
        } else {
            alert("ë¨¼ì € WebSocket ì—°ê²°ì„ í•´ì£¼ì„¸ìš”.");
        }
    }
</script>
</body>
</html>