<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/signup.css">
  <style>
    .consent-detail {
      background-color: #f9f9f9;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      display: none;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>회원가입</h1>
  <form id="signupForm">
    <label>이메일: <input type="email" name="email" required></label><br>
    <label>비밀번호: <input type="password" name="password" required></label><br>
    <label>이름: <input type="text" name="name" required></label><br>
    <label>전화번호: <input type="text" name="phone" placeholder="01012345678" required></label><br>
    <label>생년월일(6자리): <input type="text" name="rrn" placeholder="yymmdd" required></label><br>
    <label>은행명: <input type="text" name="bankName"></label><br>
    <label>은행 코드: <input type="text" name="bankCode"></label><br>
    <label>계좌번호: <input type="text" name="bankAccount"></label><br>
    <label>계좌 PIN(6자리): <input type="password" name="accountPin"></label><br>
    <label>유저 역할:
      <select name="role" required>
        <option value="PARENT">부모</option>
        <option value="CHILD">아이</option>
        <option value="TEACHER">선생님</option>
      </select>
    </label><br><br>

    <fieldset>
      <legend>약관 동의</legend>

      <label>
        <input type="checkbox" name="agreedTermsOfService" required>
        개인정보 수집 및 이용 동의 (필수)
        <a href="javascript:void(0)" onclick="toggleDetail('terms')">[보기]</a>
      </label>
      <div id="terms" class="consent-detail"></div>

      <label>
        <input type="checkbox" name="agreedPrivacyCollection" required>
        개인정보 제3자 제공 동의 (필수)
        <a href="javascript:void(0)" onclick="toggleDetail('privacy')">[보기]</a>
      </label>
      <div id="privacy" class="consent-detail"></div>

      <label>
        <input type="checkbox" name="agreedMinorGuardian" required>
        미성년자 법정대리인 동의 (필수)
        <a href="javascript:void(0)" onclick="toggleDetail('guardian')">[보기]</a>
      </label>
      <div id="guardian" class="consent-detail"></div>

      <label>
        <input type="checkbox" name="agreedElectronicFinance" required>
        전자금융거래 이용약관 동의 (필수)
        <a href="javascript:void(0)" onclick="toggleDetail('finance')">[보기]</a>
      </label>
      <div id="finance" class="consent-detail"></div>

      <label>
        <input type="checkbox" name="agreedRewardGuardian" required>
        보상 지급 관련 보호자 동의 (필수)
        <a href="javascript:void(0)" onclick="toggleDetail('reward')">[보기]</a>
      </label>
      <div id="reward" class="consent-detail"></div>

      <label>
        <input type="checkbox" name="agreedThirdPartySharing" required>
        제3자 정보 제공 동의 (필수)
        <a href="javascript:void(0)" onclick="toggleDetail('thirdparty')">[보기]</a>
      </label>
      <div id="thirdparty" class="consent-detail"></div>

      <label>
        <input type="checkbox" name="agreedDataProcessingDelegation" required>
        개인정보 처리위탁 동의 (필수)
        <a href="javascript:void(0)" onclick="toggleDetail('delegation')">[보기]</a>
      </label>
      <div id="delegation" class="consent-detail"></div>

      <label>
        <input type="checkbox" name="agreedMarketing">
        마케팅 활용 동의 (선택)
        <a href="javascript:void(0)" onclick="toggleDetail('marketing')">[보기]</a>
      </label>
      <div id="marketing" class="consent-detail"></div>

    </fieldset><br>

    <button type="submit">회원가입</button>
  </form>
</div>

<script>
  async function toggleDetail(id) {
    const el = document.getElementById(id);
    if (el.innerText === '') {
      const response = await fetch(`/consents/${id}.txt`);
      el.innerText = await response.text();
    }
    el.style.display = (el.style.display === "none") ? "block" : "none";
  }

  document.querySelector("#signupForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = e.target;
    const data = {
      email: form.email.value,
      password: form.password.value,
      name: form.name.value,
      phone: form.phone.value,
      rrn: form.rrn.value,
      bankName: form.bankName.value,
      bankCode: form.bankCode.value,
      bankAccount: form.bankAccount.value,
      accountPin: form.accountPin.value,
      role: form.role.value,
      agreedTermsOfService: form.agreedTermsOfService.checked,
      agreedPrivacyCollection: form.agreedPrivacyCollection.checked,
      agreedMinorGuardian: form.agreedMinorGuardian.checked,
      agreedElectronicFinance: form.agreedElectronicFinance.checked,
      agreedRewardGuardian: form.agreedRewardGuardian.checked,
      agreedThirdPartySharing: form.agreedThirdPartySharing.checked,
      agreedDataProcessingDelegation: form.agreedDataProcessingDelegation.checked,
      agreedMarketing: form.agreedMarketing.checked
    };
    try {
      const res = await fetch("/api-user/user/public/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        alert("회원가입 성공!");
        window.location.href = "/view/public/login";
      } else {
        const result = await res.json();
        alert("회원가입 실패: " + (result.message || "입력 오류"));
      }
    } catch (err) {
      alert("서버 오류 발생: " + err.message);
    }
  });
</script>
</body>
</html>
